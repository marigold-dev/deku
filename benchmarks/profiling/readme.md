# Profiling Deku-node

## Profiling Deku-node using Linux `perf`

```
ruby profile_node.rb
```

Profile deku node with perf:
- Tear down the deku node
- Setup deku environments
- Start deku clusters and use `perf` to get the profiling data
  + `-F 99`: Sampling CPU stacks at 99 Hertz*
  + `-g`: enable call-graph (stack chain/backtrace) recording for both kernel space 
        and user space
  + `--call-graph dwarf`: set up and enable call-graph mode, get backtraces by using `dwarf` option
  + `-a`: samples across all CPUs

  The samples are saved in a `perf.data` file. This does involve CPU, file system, and disk overheads to save the samples to the file system for later processing.
 - Sleep for 10 seconds

**Note:**
The rate for perf is 99 Hertz, the generated FlameGraph from a 1000 Hertz profile.
Choosing 99 Hertz instead of 100 Hertz, is to avoid accidentally sampling in 
lockstep with some periodic activity, which would produce skewed results.
You can also increase to higher rates (eg, up to 997 Hertz) for finer resolution.
Bear in mind that higher frequencies means higher overhead

**Note:** Setting `perf` to run without super-user permission (allow non-root users)

```
sudo sh -c 'echo -1 >/proc/sys/kernel/perf_event_paranoid'
sudo sysctl -w kernel.perf_event_paranoid=-1
sudo sh -c 'echo kernel.perf_event_paranoid=-1 > /etc/sysctl.d/local.conf'
```

`perf_event_paranoid` setting is 1:
- `-1`: Allow use of (almost) all events by all users
      Ignore mlock limit after perf_event_mlock_kb without CAP_IPC_LOCK
- `>= 0`: Disallow raw and ftrace function tracepoint - access
- `>= 1`: Disallow CPU event access
- `>= 2`: Disallow kernel profiling

To make the adjusted `perf_event_paranoid` setting permanent preserve it
in `/etc/sysctl.conf` (e.g. `kernel.perf_event_paranoid = <setting>`)

## Flamegraph

Read `perf.data` using FlameGraph. FlameGraph needs to be downloaded at:
 [FlameGraph](git clone https://github.com/brendangregg/FlameGraph)

Run this script only when `perf record` is **properly terminated** (a.k.a: `ruby profile_node.rb`).

```
ruby flamegraph.rb
```

Wait for awhile to let the graph generated. The result in picture as `perf-flamegraph.svg`. You can use internet browser to see it `firefox perf-flamegraph.svg` or chrome, etc.

### Understand Flamegraph
It shows: 
- x-axis: show the stack profile (the sample) population, sorted alphabetically
- y-axis: stack depth, counting from zero at the bottom.
- Each function (stack frame) is drawn as a rectangle, with the width relative to the number of samples. The wider a frame is, the more often it was present in the stacks.
- The top edge shows what is on-CPU.
- The beneath it is its ancestry.
- The colors are usually not significant, picked randomly to differentiate frames.

## Callgraph `gprof2dot`
 Read `perf.data` generated by Linux perf using `gprof2dot`.
 Run this script only when `perf record` is **properly terminated** (a.k.a: `ruby profile_node.rb`).

`ruby callgraphs.rb`

Install on Debian/Ubuntu run first:

```
 sudo apt-get install python3 graphviz
 sudo apt-get install python3-pip
 sudo pip install gprof2dot
```

Wait for awhile to let the graph generated. The result in picture as `callgraphs_deku_node.png`. You can use internet browser to see it `firefox callgraphs_deku_node.png` or chrome, etc.


## Read `perf.data` with [Hotspot](https://github.com/KDAB/hotspot)

Install hotspot on Debian/Ubuntu

```
add-apt-repository ppa:kubuntu-ppa/backports
apt-get update
apt-get install libkf5threadweaver-dev libkf5i18n-dev libkf5configwidgets-dev \
    libkf5coreaddons-dev libkf5itemviews-dev libkf5itemmodels-dev libkf5kio-dev libkf5parts-dev \
    libkf5solid-dev libkf5windowsystem-dev libkf5notifications-dev libkf5iconthemes-dev libelf-dev \
    libdw-dev cmake extra-cmake-modules gettext libqt5svg5-dev

apt-get install hotspot
```

Use hotspot to read `perf.data`: 
`hotspot /path/to/perf.data`