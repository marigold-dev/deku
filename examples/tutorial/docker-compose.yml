version: "3.6"
volumes:
  # Each Deku node communicates with its own instance of our VM
  # via Unix named pipes. These volumes allow the docker processes
  # to both access the same pipes.
  node-0:
  node-1:
  node-2:
  node-3:
services:
  # We run a full Tezos sandbox network using Flextesa (https://tezos.gitlab.io/flextesa/).
  # The deku-flextesa image has already been pre-populated with a Deku bridge contract
  # configured for these nodes.
  flextesa:
    container_name: deku_flextesa
    # FIXME: publish this image somewhere
    image: deku_with_felipe
    command: kathmandubox start
    environment:
      - block_time=4
      - flextesa_node_cors_origin=*
    ports:
      - 127.0.0.1:20000:20000
    expose:
      - 20000/tcp
  deku-node-0:
    container_name: deku-node-0
    image: ghcr.io/marigold-dev/deku:latest
    volumes:
      - node-0:/run/deku
    ports:
      # Deku exposes an RPC on port 8080 by default. We'll expose that
      # port on a single node to allow our frontend to communicate with
      # the network.
      - 0.0.0.0:8080:8080
    expose:
      - 8080/tcp
      # By default Deku gossip is exchanged via TCP on port 4440.
      - 4440/tcp
    environment:
      # A b58-encoded Ed25519 secret used to sign blocks
      - DEKU_SECRET=edsk4UWkJqpZrAm26qvJE8uY9ZFGFqQiFuBcDyEPASXeHxuD68WvvF
      # A list of of the tz1 public key hashes for each validator in this network
      # (derived from their secret keys)
      - DEKU_VALIDATORS=tz1fpf9DffkGAnzT6UKMDoS4hZjNmoEKhGsK,tz1PYdVbnLwiqKo3fLFXTKxw6K7BhpddQPh8,tz1Pv4viWq7ye4R6cr9SKR3tXiZGvpK34SKi,tz1cXKCCxLwYCHDSrx9hfD5Qmbs4W8w2UKDw
      - DEKU_VALIDATOR_URIS=deku-node-1:4440,deku-node-2:4440,deku-node-3:4440,deku-node-3:4440
      - DEKU_TEZOS_RPC_NODE=http://flextesa:20000
      # The secret key of a Tezos with which to post updates to Tezos. In Flextesa networks
      # this wallet is pre-seeded with funds.
      - DEKU_TEZOS_SECRET=edsk3QoqBuvdamxouPhin7swCvkQNgq4jP5KZPbwWNnwdZpSpJiEbq
      # The address of the bridge contract deployed to the deku-flextesa Tezos network.
      - DEKU_TEZOS_CONSENSUS_ADDRESS=KT1LHcxdRTgyFp1TdrgodVekLFkQwzFnTJcY
      - DEKU_API_ENABLE=true
      # During local development, it is sometimes useful to use smaller block sizes
      # and to artificially throttle the block rate so as to not consume all the CPU's resources.
      - DEKU_DEFAULT_BLOCK_SIZE=1000
      - DEKU_MINIMUM_BLOCK_LATENCY=0.5
  deku-vm-0:
    image: my-vm
    container_name: deku-vm-0
    environment:
      - DEKU_VM_DEBUG_LOGGING=true
    volumes:
      # We connect our vm to the node via the docker volume 'node-0'.
      - node-0:/run/deku
  # The rest of the config is similar for each of the three other nodes.
  deku-node-1:
    container_name: deku-node-1
    image: ghcr.io/marigold-dev/deku:latest
    volumes:
      - node-1:/run/deku
    expose:
      - 4440/tcp 
    environment:
      # Node specific config
      - DEKU_SECRET=edsk2mbL2Z7bAmRnuYbmsRe8Yu9rgAq1h993SDxoZncmqyMHDECyBa
      # Common config
      - DEKU_VALIDATORS=tz1fpf9DffkGAnzT6UKMDoS4hZjNmoEKhGsK,tz1PYdVbnLwiqKo3fLFXTKxw6K7BhpddQPh8,tz1Pv4viWq7ye4R6cr9SKR3tXiZGvpK34SKi,tz1cXKCCxLwYCHDSrx9hfD5Qmbs4W8w2UKDw
      - DEKU_VALIDATOR_URIS=deku-node-1:4440,deku-node-2:4440,deku-node-3:4440,deku-node-3:4440
      - DEKU_TEZOS_RPC_NODE=http://flextesa:20000
      - DEKU_TEZOS_SECRET=edsk3QoqBuvdamxouPhin7swCvkQNgq4jP5KZPbwWNnwdZpSpJiEbq
      - DEKU_TEZOS_CONSENSUS_ADDRESS=KT1LHcxdRTgyFp1TdrgodVekLFkQwzFnTJcY
      - DEKU_API_ENABLE=true
      - DEKU_DEFAULT_BLOCK_SIZE=1000
      - DEKU_MINIMUM_BLOCK_LATENCY=0.5
  deku-vm-1:
    image: my-vm
    container_name: deku-vm-1
    volumes:
      - node-1:/run/deku
  deku-node-2:
    container_name: deku-node-2
    image: ghcr.io/marigold-dev/deku:latest
    volumes:
      - node-2:/run/deku
    expose:
      - 4440/tcp 
    environment:
      # Node specific config
      - DEKU_SECRET=edsk3dx8ZfcaBXsuLsk8fawS1qxjHbZtEoEdpAwxhsjmYTQhoEUxFk
      # Common config
      - DEKU_VALIDATORS=tz1fpf9DffkGAnzT6UKMDoS4hZjNmoEKhGsK,tz1PYdVbnLwiqKo3fLFXTKxw6K7BhpddQPh8,tz1Pv4viWq7ye4R6cr9SKR3tXiZGvpK34SKi,tz1cXKCCxLwYCHDSrx9hfD5Qmbs4W8w2UKDw
      - DEKU_VALIDATOR_URIS=deku-node-1:4440,deku-node-2:4440,deku-node-3:4440,deku-node-3:4440
      - DEKU_TEZOS_RPC_NODE=http://flextesa:20000
      - DEKU_TEZOS_SECRET=edsk3QoqBuvdamxouPhin7swCvkQNgq4jP5KZPbwWNnwdZpSpJiEbq
      - DEKU_TEZOS_CONSENSUS_ADDRESS=KT1LHcxdRTgyFp1TdrgodVekLFkQwzFnTJcY
      - DEKU_API_ENABLE=true
      - DEKU_DEFAULT_BLOCK_SIZE=1000
      - DEKU_MINIMUM_BLOCK_LATENCY=0.5
  deku-vm-2:
    image: my-vm
    container_name: deku-vm-2
    volumes:
      - node-2:/run/deku   
  deku-node-3:
    container_name: deku-node-3
    image: ghcr.io/marigold-dev/deku:latest
    volumes:
      - node-2:/run/deku
    expose:
      - 4440/tcp 
    environment:
      # Node specific config
      - DEKU_SECRET=edsk3MwFfcGp5FsZgrX8FGiBiDutX2kfAuPzU6VdZpKYLyDRVPb879
      # Common config
      - DEKU_VALIDATORS=tz1fpf9DffkGAnzT6UKMDoS4hZjNmoEKhGsK,tz1PYdVbnLwiqKo3fLFXTKxw6K7BhpddQPh8,tz1Pv4viWq7ye4R6cr9SKR3tXiZGvpK34SKi,tz1cXKCCxLwYCHDSrx9hfD5Qmbs4W8w2UKDw
      - DEKU_VALIDATOR_URIS=deku-node-1:4440,deku-node-2:4440,deku-node-3:4440,deku-node-3:4440
      - DEKU_TEZOS_RPC_NODE=http://flextesa:20000
      - DEKU_TEZOS_SECRET=edsk3QoqBuvdamxouPhin7swCvkQNgq4jP5KZPbwWNnwdZpSpJiEbq
      - DEKU_TEZOS_CONSENSUS_ADDRESS=KT1LHcxdRTgyFp1TdrgodVekLFkQwzFnTJcY
      - DEKU_API_ENABLE=true
      - DEKU_DEFAULT_BLOCK_SIZE=1000
      - DEKU_MINIMUM_BLOCK_LATENCY=0.5
  deku-vm-3:
    image: my-vm
    container_name: deku-vm-3
    volumes:
      - node-3:/run/deku   
